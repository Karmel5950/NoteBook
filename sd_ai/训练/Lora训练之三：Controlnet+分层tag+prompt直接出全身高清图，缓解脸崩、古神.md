在NGA发了一些帖子讲SD 三次元绘画的经验，我也看到很多问题，因为时间原因我也没有一一回复。我发现一个比较常见的问题是肢体错位和脸部错误，或者是脸部模糊不清，变形，特别是在全身图中。  
  
第一个帖子([[https://bbs.nga.cn/read.php?tid=35774713)](https://bbs.nga.cn/read.php?tid=35774713))]我大概介绍了一下SD的工作原理，就是随机出图、对照条件(条件可以是prompt或者lora)判断是否符合要求，舍弃不符合要求的图，在最可能符合要求的图上继续随机作画，再判断…… 以此类推。这是AI绘画随机性的根本来源，也是错误的原因：AI无法满足玩家提出的条件。  
  
下面我以一些例子说一些常见的问题：  
  
1，为什么全身图脸会崩？ 构图错误(古神)是怎么回事？  
  

− 展开 ...

  
  
![](https://img.nga.178.com/attachments/mon_202304/09/-9lddQ8so7-kh5rZbT1kSh4-op.jpg)  
  
先随便找一张全身照，用网格划分一下，很容易看到，面部最多占1格，就算把头发、脖子也算进去，也最多是2格。而这张全身照(2:3,对应512:768) 差不多有接近40格的面积了。也就是说，在这样一张有头、有脚的完整的全身照里面，头部(特别是面部)占比不超过5%，大约是3-4%的样子。  
  
假设我们要出一张768：1024的图，总面积是786432，按照4%算，面部面积是31450左右，假设面部是正方形，则面部的尺寸是177*177左右——比你想象的小得多。  
  
按照人类的思维，我用来训练的面部尺寸都远大于这个，比方说我用来训练的面部尺寸是512*512的，远大于这个面积，我应该“缩小”了这个面部放进去，还保持起码的形状吧？ 但是实际上不可行的原因是AI并没有“缩放"你的模型，而是随机形成面部，比照你的模型，通过近似程度判断是否符合要求。  
  
那么在177*177的尺度上随机形成图形，并要求这个图形“近似”一张512*512的头部图是荒唐的，不像甚至完全崩了很正常。  
  
办法也是有的，你假设要出这么大的图，你可以把你自己训练集的脸部都减少到这么小——但是好像训练最低允许256*256，也就是你要保证你出图的脸部尺寸大约是这个数字，这能最大限度的减缓脸部变形。  
  
但是没人愿意主动降低清晰度——所以另一个办法就是增大总面积，直接出大图。  
  
假设我们要求全身状态下面部至少能与512*512清晰度的素材近似，那么我们应该出多大的图？  
  
  
总面积应该不小于512万像素左右——如果用正方形的话，边长大概是2400*2400，3：4的竖版图应该大约是2000：2600左右(数字都是我心算的，不精确)  
  
你在网上看到的那些高清的全身大图，都是4070以上出的吧？哈哈哈。。。  
  
所以换显卡吧！  
  
  
那换个思路，能否让AI直接出一张大图，套用我自己做的脸部呢？  
  
大多数情况下也不行！  
  
因为大多数情况下，用于训练的图片质量也很低，如果图很大，比如1920x2800，用于训练的图片就显得严重偏小。按照上面那张示例图看，身体大约占全图面积的20%左右，在大图中可能相当于512*512的面积，可是很多情况下我们训练的身体图(reg)尺寸也就只有512*768，身体在其中占的面积就更小了，结果就是头部正确绘制了，但是身体是错误的。  
  
而要训练大图，还是要大显卡，嘿嘿。  
  
  
所以，想要增强脸部的有效性，就要尽可能让图片中脸部的大小接近你训练集中脸部的大小，尽可能的让出的图扩大。当然最终的解决方案还是花钱买卡。  
  
当然，你还可以出cowboy shot，不出full body来解决这个问题。  
  
  

  
  
  
2，底模、prompt、Lora、control net、权重之间的关系  
  
所有的参数之间都是竞争的关系。  
  
参见我第一个帖子里描述了prompt的工作流程。  
  
对于机器而言，权重是指衡量与目标(模型、底模、lora等)的相似程度，多相似被认定为有效？这个数值越大越近似于目标，过大会过拟合。本身数值是多大并不重要，0.5比0.3更近似(但也更容易过拟合)，0.3又比0.25更近似。  
  
如果有多个条件要求同时符合，则参数间的权重会互相竞争。很难保证AI让你画的1girl既像A又像B，所以只能做出取舍。这种取舍通过权重的相对关系来决定，具体来说，这个权重高了，等同于另一个的权重低了。  
  
control net 也是一个特殊的模型，也要占据权重。当使用control net 时，势必使得其他权重相对下降，造成失真。  
  
但是如果你的训练集让你无法直接正确生成大图，必须使用control net，这些权重上的牺牲(比如脸部不太像)有时候是必须付出的代价，不然甚至出不了一张图。  
  
  
  
3，对lora进行分层tag  
  
原帖：[[https://bbs.nga.cn/read.php?tid=35850123](https://bbs.nga.cn/read.php?tid=35850123)]  
  
分层的主要考虑是使得AI在模型中最高概率命中对应的构图，降低构图错误率。但是这并不能改善因为训练集尺寸与出图尺寸不符的问题。  
  
好处是，你有时候在某些分辨率(比如900x1200)下，可以运气好的碰到一些不错的构图，在不使用control net的情况下得到比较满意的结果。上面一段已经描述，使用control net也要付出代价，代价就是control net要占权重，必然会导致其他元素、prompt、模型(lora等)的权重相对下降。  
  
  
  
4，lora分层+control net  
  
下面要说到重点，controlnet 是怎么工作的。  
  
controlnet 本身可以视为一个模型，本身要占一个权重，会与其他模型(比如lora)和提示词冲突。但是如果你在prompt、lora中描述的姿势和构图与control net 里的构图完全一致，就可以使control net与这些尽可能减小冲突，实现最小代价的配合。  
  
下面举一个案例：  
  

− 展开 ...

  
通常对于sd的prompt而言，half body是指上半身照，cowboyshot 是更大一点的，大概是从大腿以上的部分。 那么如果图片仅仅缺少脚(就是指截取到膝盖以下)，到底算什么呢？ 我通常情况下认为应该算full body。  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQ0-5vd5ZsT3cSow-xc.jpg)  
  
比如这张图，我按照full body出的，结果出到了膝盖就结束了。 这是因为训练集里面就没有膝盖以下的部分，才会出现这种情况，而我把这样比例的训练集图片都定义成了full body。  
  
但是一旦用了control net，情况就不一样了。  
  
当我用了一个全身(包含脚部)的control net 时，control net 会试图让其他元素(比如lora)去适应它的比例关系：  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-1iboZuT3cSow-xc.jpg)  
  
可以明显看到裙子被拉伸了以适应control net 的构图(全身)。  
  
接下来截短control net 的结构图  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-ffbzK18T3cSl8-sg.jpg)  
  
去掉脚部的最后一个关节，再用control net + full body出图，比例恢复正常。  
  
那么假如这个模型本来就没有脚(很正常)，怎么给它加出一只脚呢?  
  
我试了一下，首先在不降低control net 权重的情况下，添加与脚有关的prompt是没用的。但是如果降低了太多control net 的权重，整个图片又会出错。  
  
最终决定引入一个鞋子的lora(制作过程在前面的帖子里)  
  
通过prompt引用鞋子的lora中的关键词 high heels，同时鞋子lora里面有对应full body的构图，control net 的全身构图里也有脚部，成功实现了让control net 在衣服构图不完整的情况下出全身图：  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-i1vuZ11T3cSow-xc.jpg)  
  
但是可以看出来，面部细节损失比较严重，因为引用了太多的要素(三个lora+ control net)  
  
不过这也基本实现了“幻化式换装”的目的~  

  
  
  
5，control net 的一些问题  
  
control net 能支持多大的图片？  
  
实测我素材训练集512*768，control net 能坚持到1200*1600 左右才崩，实际上大概1080*1440左右细节能控制，再追求精细就只能900*1200了，在放大用upscale工具。  
  
control net 需要多大的权重，会与其他lora竞争多少权重？  
  
实际上control net 权重越高，越会严格按照你规定的姿势来，权重略低可以有一点随机空间。因此如果不是对姿势非常严格，可以适当降低(比如0.8或者0.75)control net 的权重，来为其他的lora、prompt留出权重空间。  
  
control net 成功率与比例失调的问题  
  
这是个有意思的问题，看实验：  
  

− 展开 ...

  
就用本文开头的一张图作为骨架模板：  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-byj1ZcT3cSp3-sg.jpg)  
  
  
按照这个骨架出一些图，这里control net 我权重选择1  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-hjitZqT3cSlc-sg.jpg)  
  
结果3个是错的，就这么一个及其简单的脚部动作，左脚叠在右脚前面(在骨架图里面已经表示了先后关系)，AI还是难以画对，4张错了3张。这也再次说明了AI的绘图原理，只要随机绘图，AI认为与条件“足够接近”就算成功。  
  
看起来这几张图对于AI而言，都与1.0的control net 骨架足够“接近”了……  
  
另外一个就是比例还有些失衡，看样图中，人物是顶天立地的，其实在真实照片中，特别是全身图，很少出现这种情况。  
  
我现在把唯一一张还能看的拿出来：  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-jhtuZiT3cSlc-sg.jpg)  
  
用同一个种子，这次把骨架等比缩小一下：  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQjsi-4arwK2pT3cSio-sg.jpg)  
  
  
出来的图是这样的：  
  
  
![](https://img.nga.178.com/attachments/mon_202304/10/-9lddQpon4-k070ZlT3cSlc-sg.jpg)  
  
这张图为什么是歪的呢？因为脚画错了，如果不歪的话人物就是歪的。。。  
  
所以，对control net 也不要迷信，或者只用一些最简单的姿势。  
  
  
  

  
  
  
出图总结:  
  
  
能出多大出多大，大图才可能随机出更接近你脸部模型的脸部来。如果不能，就出半身或者七分身。  
  
能不用、少用模型，包括control net 就不用，少用模型。能用少的权重不用多的权重，只有每一个“要素”分到更多的权重，才能更接近你的要求。  
  
尽可能让prompt、Lora中的tag与control net 的结构图相符，才能最大限度减少冲突，增加成功率。  
  
https://bbs.nga.cn/read.php?&tid=35918258